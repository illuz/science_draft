<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <!-- <title>æ™ºèƒ½ç†ç§‘è‰ç¨¿æœ¬ Ultimate</title> -->
  
  <!-- 1. å¼ºåˆ¶å…¼å®¹ä»£ç ï¼šç¡®ä¿ math.js èƒ½æ³¨å…¥åˆ° window -->
  <script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>
  <script src="math.min.js"></script>
  <script>if (window.module) module = window.module;</script>

  <!-- 2. å¼•å…¥æ–°æ¨¡å— -->
  <script src="config.js"></script>
  <script src="auto_save.js"></script>

  <style>
    /* === å…¨å±€æ·±è‰²ä¸»é¢˜ === */
    body, html { margin: 0; padding: 0; height: 100%; font-family: "Consolas", "Microsoft YaHei", sans-serif; background: #303133; color: #E0E0E0; overflow: hidden; }
    
    /* 1. é¡¶éƒ¨æ ‡é¢˜æ  (æ–°é…è‰² #5D5950) */
    .header {
      height: 40px;
      background: #5D5950;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      user-select: none;
      z-index: 10;
      position: relative;
    }
    .header-left { display: flex; align-items: center; gap: 10px; max-width: calc(100% - 80px); }
    .header-right { display: flex; align-items: center; gap: 8px; }
    .header-title { font-size: 14px; font-weight: bold; color: #fff; letter-spacing: 1px; opacity: 0.9; }

    /* Tab æ ‡ç­¾é¡µæ ·å¼ */
    .tabs-container {
      display: flex;
      align-items: center;
      gap: 5px;
      flex: 1;
      overflow-x: auto;
      overflow-y: hidden;
      scrollbar-width: thin;
      scrollbar-color: rgba(255,255,255,0.3) transparent;
    }
    .tabs-container::-webkit-scrollbar {
      height: 4px;
    }
    .tabs-container::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.3);
      border-radius: 2px;
    }
    .tabs-container::-webkit-scrollbar-track {
      background: transparent;
    }
    .tab {
      display: flex;
      align-items: center;
      gap: 6px;
      background: rgba(0,0,0,0.2);
      padding: 4px 10px;
      border-radius: 4px 4px 0 0;
      cursor: pointer;
      transition: 0.2s;
      border: 1px solid transparent;
      user-select: none;
      flex-shrink: 0; /* é˜²æ­¢ tab è¢«å‹ç¼© */
    }
    .tab:hover {
      opacity: 0.9;
    }
    .tab.active {
      background: #3498db;
      border-color: #3498db;
    }
    .tab-name {
      font-size: 12px;
      color: #fff;
      max-width: 100px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .tab-close {
      font-size: 14px;
      color: rgba(255,255,255,0.6);
      cursor: pointer;
      padding: 0 3px;
      border-radius: 3px;
      transition: 0.2s;
    }
    .tab-close:hover {
      background: rgba(255,255,255,0.2);
      color: #fff;
    }
    .tab-add {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      background: rgba(0,0,0,0.2);
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      color: #fff;
      transition: 0.2s;
    }
    .tab-add:hover {
      background: #3498db;
      transform: scale(1.1);
    }

    /* å³ä¾§å›¾æ ‡æŒ‰é’® */
    .icon-btn-header {
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.2);
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      color: #ddd;
      transition: 0.2s;
    }
    .icon-btn-header:hover {
      background: rgba(0,0,0,0.4);
      color: #fff;
      transform: scale(1.1);
    }

    /* 2. ä¸»å®¹å™¨ */
    .main-container { display: flex; height: calc(100% - 40px); position: relative; }
    
    /* 3. ç¼–è¾‘å™¨ (èå…¥èƒŒæ™¯ï¼Œå»é™¤è¾¹æ¡†) */
    #editor {
      flex: 1;
      height: 100%;
      padding: 30px;
      padding-bottom: 80px; /* ç»™åº•éƒ¨å·¥å…·æ ç•™å‡ºç©ºé—´ */
      border: none;
      resize: none;
      outline: none;
      font-size: 20px;
      line-height: 1.8;
      box-sizing: border-box;
      background: #303133;
      color: #E0E0E0;
      font-family: inherit;
    }
    /* é€‰ä¸­æ–‡å­—é¢œè‰² */
    ::selection { background-color: #5D5950; color: #fff; }
    /* æ»šåŠ¨æ¡æ·±è‰²åŒ– */
    ::-webkit-scrollbar { width: 8px; background: #303133; }
    ::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }

    /* 4. åº•éƒ¨æ‚¬æµ®å·¥å…·æ  (æ ¸å¿ƒæ–°å¢æ ·å¼) */
    .bottom-bar {
      position: absolute;
      bottom: 15px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 15px;
      background: rgba(0, 0, 0, 0.3); /* åŠé€æ˜é»‘åº• */
      padding: 6px 20px;
      border-radius: 20px;
      backdrop-filter: blur(5px);
      z-index: 100;
      transition: all 0.3s;
    }
    .bottom-bar:hover { background: rgba(0, 0, 0, 0.6); }

    .icon-btn {
      width: 28px;   /* å®šä¹‰æŒ‰é’®åŒºåŸŸå¤§å° */
      height: 28px;
      cursor: pointer;
      transition: 0.2s;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }/* å›¾ç‰‡æ ·å¼æ§åˆ¶ */
    .icon-btn img {
      width: 18px;   /* å›¾æ ‡æ˜¾ç¤ºå¤§å° */
      height: 18px;
      opacity: 0.6;  /* é»˜è®¤ç¨å¾®æš—ä¸€ç‚¹ */
      /* filter: invert(1); */ /* å¦‚æœä½ çš„å›¾æ ‡æ˜¯çº¯é»‘è‰²çš„ï¼Œå–æ¶ˆè¿™è¡Œçš„æ³¨é‡ŠæŠŠå®ƒå˜ç™½ */
      transition: all 0.2s;
    }

    /* æ‚¬åœæ•ˆæœ */
    .icon-btn:hover {
      transform: translateY(-3px); /* å‘ä¸Šæµ®åŠ¨ */
    }
    
    .icon-btn:hover img {
      opacity: 1; /* å˜äº® */
    }

    /* æ‚¬åœæç¤ºæ–‡å­—ä½ç½®å¾®è°ƒ */
    .icon-btn:hover::after {
      content: attr(data-tip);
      position: absolute;
      top: -35px;
      background: #000;
      color: #fff;
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 4px;
      white-space: nowrap;
    }
    .icon-btn:hover { color: #fff; transform: translateY(-3px); }
    /* é¼ æ ‡æ‚¬åœæç¤º */
    .icon-btn:hover::after {
      content: attr(data-tip);
      position: absolute;
      top: -35px;
      background: #000;
      color: #fff;
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 4px;
      white-space: nowrap;
    }

    /* 5. ä¾§è¾¹æ  (æ·±è‰² #2B2B2B) */
    #image-sidebar {
      width: 0;
      background: #2B2B2B;
      border-left: 1px solid #444;
      overflow-y: auto;
      transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0;
      z-index: 20;
    }
    #image-sidebar.active { width: 300px; padding: 15px; }
    
    .sidebar-tip { font-size:12px; color:#666; margin:20px 0; text-align:center; width:100%; }

    /* å›¾ç‰‡å¡ç‰‡æ·±è‰²é€‚é… */
    .img-card {
      width: 100%;
      background: #3c3f41;
      margin-bottom: 15px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      position: relative;
      border: 2px solid transparent;
      cursor: zoom-in;
      overflow: hidden;
      transition: 0.2s;
    }
    .img-card:hover { border-color: #888; transform: scale(1.02); }
    .img-card img { width: 100%; display: block; pointer-events: none; }
    .img-card .del-btn {
      position: absolute; top: 5px; right: 5px; width: 22px; height: 22px;
      background: rgba(0,0,0,0.6); color: #fff; border-radius: 50%;
      text-align: center; line-height: 20px; display: none; font-size: 14px;
      cursor: pointer;
      color: white; /* ç¡®ä¿å‰å·æ˜¯ç™½è‰² */
    }
    .img-card:hover .del-btn { display: block; }

    /* 6. å¸®åŠ©å¼¹çª— (æ·±è‰²é€‚é…) */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; display: flex; align-items: center; justify-content: center; }
    .modal-content { background: #3c3f41; color: #eee; padding: 25px; border-radius: 12px; width: 600px; max-height: 85vh; overflow-y: auto; box-shadow: 0 15px 50px rgba(0,0,0,0.5); border: 1px solid #555; }
    
    table { width:100%; font-size:13px; border-collapse: collapse; margin-top:10px; color: #ccc; }
    th, td { padding:8px; border-bottom:1px solid #555; text-align:left; }
    th { background:#333; color: #fff; }
    code { background: #222; padding: 2px 5px; border-radius: 3px; color: #e67e22; font-family: "Consolas"; }
    .key-tag { border: 1px solid #666; padding: 1px 6px; border-radius: 4px; font-size: 12px; background: #444; color: #fff; }
    
    .btn-close {
      background: #5D5950; color: #fff; border: none; padding: 8px 30px; border-radius: 4px; cursor: pointer; margin-top: 20px; transition: 0.2s;
    }
    .btn-close:hover { background: #777265; }

    /* 7. è®¾ç½®é¢æ¿æ ·å¼ */
    .settings-panel {
      background: #3c3f41;
      padding: 20px;
      border-radius: 8px;
      max-width: 600px;
      margin: 0 auto;
    }
    .settings-section {
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #555;
    }
    .settings-section:last-child { border-bottom: none; }
    .settings-section h3 {
      color: #3498db;
      font-size: 16px;
      margin: 0 0 15px 0;
    }
    .settings-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    .settings-row label { color: #ccc; font-size: 14px; }
    .settings-row input[type="text"],
    .settings-row input[type="number"] {
      background: #2B2B2B;
      color: #fff;
      border: 1px solid #555;
      padding: 6px 10px;
      border-radius: 4px;
      width: 200px;
      outline: none;
    }
    .settings-row input:focus { border-color: #3498db; }
    .settings-row button {
      background: #3498db;
      color: #fff;
      border: none;
      padding: 6px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      transition: 0.2s;
    }
    .settings-row button:hover { background: #2980b9; }
    .settings-row button.danger {
      background: #e74c3c;
    }
    .settings-row button.danger:hover { background: #c0392b; }

    /* å¼€å…³æŒ‰é’® */
    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #555;
      transition: 0.3s;
      border-radius: 24px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
    }
    input:checked + .slider { background-color: #3498db; }
    input:checked + .slider:before { transform: translateX(26px); }

    /* åˆ†ç»„åˆ—è¡¨ */
    .group-list {
      background: #2B2B2B;
      padding: 10px;
      border-radius: 4px;
      max-height: 200px;
      overflow-y: auto;
    }
    .group-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 10px;
      margin-bottom: 5px;
      background: #3c3f41;
      border-radius: 4px;
    }
    .group-item span { color: #fff; font-size: 14px; }
    .group-item button {
      background: #e74c3c;
      color: #fff;
      border: none;
      padding: 4px 10px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 12px;
    }
    .group-item button:hover { background: #c0392b; }

    /* è‡ªå®šä¹‰å¯¹è¯æ¡†æ ·å¼ */
    .custom-dialog {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 3000;
    }
    .custom-dialog.show { display: flex; }
    .dialog-box {
      background: #3c3f41;
      padding: 20px;
      border-radius: 8px;
      min-width: 300px;
      max-width: 500px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    }
    .dialog-title {
      font-size: 16px;
      font-weight: bold;
      color: #fff;
      margin-bottom: 15px;
    }
    .dialog-message {
      color: #ccc;
      font-size: 14px;
      line-height: 1.6;
      margin-bottom: 15px;
      white-space: pre-line;
    }
    .dialog-input {
      width: 100%;
      background: #2B2B2B;
      color: #fff;
      border: 1px solid #555;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 14px;
      margin-bottom: 15px;
      box-sizing: border-box;
      outline: none;
    }
    .dialog-input:focus { border-color: #3498db; }
    .dialog-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    .dialog-btn {
      padding: 8px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: 0.2s;
    }
    .dialog-btn-primary {
      background: #3498db;
      color: #fff;
    }
    .dialog-btn-primary:hover { background: #2980b9; }
    .dialog-btn-secondary {
      background: #555;
      color: #fff;
    }
    .dialog-btn-secondary:hover { background: #666; }

    /* å¯¹è¯æ¡†å†…çš„é¢œè‰²é€‰æ‹©å™¨ */
    .dialog-color-picker {
      margin: 15px 0;
    }
    .dialog-color-label {
      color: #ccc;
      font-size: 13px;
      margin-bottom: 8px;
      display: block;
    }
    .dialog-color-options {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .dialog-color-dot {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.2s;
      position: relative;
    }
    .dialog-color-dot:hover {
      transform: scale(1.15);
      border-color: rgba(255,255,255,0.3);
    }
    .dialog-color-dot.selected {
      border-color: #fff;
      box-shadow: 0 0 8px rgba(255,255,255,0.6);
    }
    .dialog-color-dot.selected::after {
      content: 'âœ“';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 14px;
      font-weight: bold;
    }

    /* è½»é‡çº§æ¶ˆæ¯æç¤º */
    .toast-message {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: rgba(0, 0, 0, 0.75);
      color: #aaa;
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 13px;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.3s ease;
      pointer-events: none;
      z-index: 4000;
      max-width: 300px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .toast-message.show {
      opacity: 1;
      transform: translateY(0);
    }

    /* æœç´¢æ¡†æ ·å¼ */
    .search-box {
      position: fixed;
      top: 60px;
      right: 30px;
      background: #3c3f41;
      padding: 12px 15px;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      display: none;
      z-index: 3500;
      min-width: 300px;
    }
    .search-box.show {
      display: block;
    }
    .search-box-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .search-box-title {
      color: #fff;
      font-size: 14px;
      font-weight: bold;
    }
    .search-box-close {
      color: #999;
      cursor: pointer;
      font-size: 20px;
      line-height: 1;
      padding: 0 5px;
    }
    .search-box-close:hover {
      color: #fff;
    }
    .search-input-wrapper {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }
    .search-input {
      flex: 1;
      background: #2B2B2B;
      color: #fff;
      border: 1px solid #555;
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 13px;
      outline: none;
    }
    .search-input:focus {
      border-color: #3498db;
    }
    .search-nav-btn {
      background: #555;
      color: #fff;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: 0.2s;
    }
    .search-nav-btn:hover {
      background: #666;
    }
    .search-info {
      color: #888;
      font-size: 12px;
      text-align: center;
    }
  </style>
</head>
<body>

<!-- é¡¶éƒ¨ Header -->
<div class="header">
  <div class="header-left">
    <!-- Tab æ ‡ç­¾é¡µ -->
    <div class="tabs-container" id="tabs-container">
      <div class="tab active" data-group="éšä¾¿ç®—ç®—">
        <span class="tab-name">éšä¾¿ç®—ç®—</span>
        <span class="tab-close">Ã—</span>
      </div>
    </div>
    <div class="tab-add" id="tab-add" title="æ·»åŠ åˆ†ç»„">+</div>
  </div>
  <!-- å³ä¾§æŒ‰é’®ç»„ -->
  <div class="header-right">
    <div class="icon-btn-header" id="btn-settings" title="è®¾ç½®">âš™</div>
    <div class="icon-btn-header" id="btn-help" title="å¸®åŠ©">?</div>
  </div>
</div>

<div class="main-container">
    <!-- åº•éƒ¨æ‚¬æµ®å·¥å…·æ  -->
<div class="bottom-bar">
  <!-- æ¸…å± -->
  <div class="icon-btn" id="btn-clear" data-tip="æ¸…ç©º">
    <!-- è¯·ç¡®ä¿æ‚¨çš„ icons æ–‡ä»¶å¤¹é‡Œæœ‰ clear.png -->
    <img src="icons/clear.png" alt="æ¸…ç©º">
  </div>
  
  <!-- ç´ ææ å¼€å…³ -->
  <div class="icon-btn" id="btn-sidebar" data-tip="ç´ ææ ">
    <img src="icons/image.png" alt="ç´ æ">
  </div>

  <!-- ä¿å­˜åˆ°å½“å‰åˆ†ç»„ -->
  <div class="icon-btn" id="btn-save" data-tip="ä¿å­˜">
    <img src="icons/save.png" alt="ä¿å­˜">
  </div>
</div>
  <textarea id="editor" placeholder="è¾“å…¥ 1+1= è®¡ç®—...\nè¾“å…¥ x^-2 [ç©ºæ ¼] å˜ä¸Šæ ‡..."></textarea>
  <div id="image-sidebar">
    <div class="sidebar-tip">Ctrl+V ç²˜è´´å›¾ç‰‡<br>åŒå‡»åœ¨æ–°çª—å£ç¼–è¾‘</div>
  </div> 
</div>

<!-- å‡çº§ç‰ˆå¸®åŠ©å¼¹çª— -->
<div id="help-modal" class="modal-overlay" style="display:none;">
  <div class="modal-content" style="width: 680px; max-height: 85vh; display:flex; flex-direction:column;">
    
    <!-- å¼¹çª—æ ‡é¢˜æ  -->
    <div class="modal-header" style="border-bottom: 2px solid #3498db; padding-bottom: 10px; margin-bottom: 15px; display:flex; justify-content:space-between; align-items:center;">
       <span style="font-size:18px; font-weight:bold; color:#2c3e50;">ğŸ“š æ™ºèƒ½ç†ç§‘è‰ç¨¿æœ¬ - å…¨èƒ½æŒ‡å—</span>
       <button style="border:none; background:none; cursor:pointer; font-size:24px; color:#999;" onclick="document.getElementById('help-modal').style.display='none'">Ã—</button>
    </div>

    <div class="modal-body" style="font-size: 14px; line-height: 1.6; overflow-y:auto; padding-right:5px;">
      
      <!-- æ¿å— 1: æ ¸å¿ƒäº¤äº’ -->
      <h3 style="color:#2c3e50; border-left: 4px solid #3498db; padding-left: 10px; margin-top: 0; background:#f4f6f8; padding-top:5px; padding-bottom:5px;">âš¡ æ ¸å¿ƒäº¤äº’æŠ€å·§</h3>
      <ul style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding-left: 20px; margin: 10px 0;">
        <li><strong>è®¡ç®—é¢„è§ˆï¼š</strong> è¾“å…¥ <code>1+1=</code> æ˜¾ç¤ºç°è‰²ç»“æœã€‚</li>
        <li><strong>ç¡®è®¤ä¸Šå±ï¼š</strong> æŒ‰ <span class="key-tag">Tab</span> é”®å°†ç»“æœå†™å…¥è‰ç¨¿ã€‚</li>
        <li><strong>æ™ºèƒ½ä¸Šæ ‡ï¼š</strong> è¾“å…¥ <code>x^-2</code> åæŒ‰ <span class="key-tag">ç©ºæ ¼</span> â†’ xâ»Â²ã€‚</li>
        <li><strong>ç¬¦å·æ›¿æ¢ï¼š</strong> <code>pi</code>â†’Ï€ï¼Œ<code>*</code>â†’Ã—ï¼Œ<code>sqrt</code>â†’âˆšã€‚</li>
        <li><strong>ç´ æç®¡ç†ï¼š</strong> <span class="key-tag">Ctrl+V</span> ç²˜è´´æˆªå›¾ï¼ŒåŒå‡»å›¾ç‰‡ç¼–è¾‘ã€‚</li>
        <li><strong>ä¸€é”®æ¸…å±ï¼š</strong> ç‚¹å‡»é¡¶éƒ¨â€œğŸ—‘ï¸ æ¸…å±â€é‡ç½®ç”»å¸ƒã€‚</li>
      </ul>

      <!-- æ¿å— 2: æ–‡ä»¶ç®¡ç† -->
      <h3 style="color:#2c3e50; border-left: 4px solid #e67e22; padding-left: 10px; background:#f4f6f8; padding-top:5px; padding-bottom:5px;">ğŸ“‚ æ–‡ä»¶ä¸é¡¹ç›®ç®¡ç†</h3>
      <div style="padding: 0 10px;">
        <p><strong>ğŸ’¾ å­˜ä¸ºæ–‡ä»¶å¤¹ï¼š</strong> æ¨èä½¿ç”¨ï¼ç³»ç»Ÿä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªå¸¦æ—¶é—´æˆ³çš„æ–‡ä»¶å¤¹ï¼ˆå¦‚ <code>20251010_ä½œä¸šA</code>ï¼‰ï¼Œå°†ä½ çš„<strong>æ–‡å­—è‰ç¨¿</strong>(txt)å’Œ<strong>æ‰€æœ‰å›¾ç‰‡ç´ æ</strong>(png)å®Œæ•´æ‰“åŒ…ä¿å­˜ã€‚</p>
        <p><strong>ğŸ“‚ æ‰“å¼€æ–‡ä»¶å¤¹ï¼š</strong> é€‰æ‹©ä¹‹å‰çš„é¡¹ç›®æ–‡ä»¶å¤¹ï¼Œå³å¯ä¸€é”®æ¢å¤å½“æ—¶çš„æ‰€æœ‰è®¡ç®—è¿‡ç¨‹å’Œå›¾ç‰‡æ ‡è®°ã€‚</p>
      </div>

      <!-- æ¿å— 3: ç†ç§‘å‡½æ•° -->
      <h3 style="color:#2c3e50; border-left: 4px solid #27ae60; padding-left: 10px; background:#f4f6f8; padding-top:5px; padding-bottom:5px;">ğŸ§® ç†ç§‘å‡½æ•°é€ŸæŸ¥è¡¨</h3>
      <table style="width:100%; font-size:13px; border-collapse: collapse; border: 1px solid #eee;">
        <tr style="background:#f8f9fa; color:#666; text-align:left;">
          <th style="padding:8px; border-bottom:1px solid #ddd;">åˆ†ç±»</th>
          <th style="padding:8px; border-bottom:1px solid #ddd;">è¯­æ³•ç¤ºä¾‹</th>
          <th style="padding:8px; border-bottom:1px solid #ddd;">è¯´æ˜</th>
        </tr>
        <tr>
          <td><strong>åŸºç¡€ä»£æ•°</strong></td>
          <td><code>5!</code> / <code>sqrt(9)</code> / <code>abs(-5)</code></td>
          <td>é˜¶ä¹˜ã€æ ¹å·ã€ç»å¯¹å€¼</td>
        </tr>
        <tr>
          <td><strong>ä¸‰è§’å‡½æ•°</strong></td>
          <td><code>sin(30 deg)</code> / <code>cos(pi)</code></td>
          <td>åŠ¡å¿…åŒºåˆ† deg(åº¦) å’Œ rad(å¼§åº¦)</td>
        </tr>
        <tr>
          <td><strong>æ’åˆ—ç»„åˆ</strong></td>
          <td><code>combinations(5, 2)</code></td>
          <td>ä» 5 ä¸ªä¸­å– 2 ä¸ªçš„ç»„åˆæ•° (Câ‚…Â²)</td>
        </tr>
        <tr>
          <td><strong>æ±‚å’Œ/ç»Ÿè®¡</strong></td>
          <td><code>sum(1, 2, 3)</code> / <code>mean(1, 2, 3)</code></td>
          <td>æ±‚å’Œã€æ±‚å¹³å‡å€¼</td>
        </tr>
        <tr>
          <td><strong>å¤æ‚æ±‚å’Œ</strong></td>
          <td><code>sigma(x^2, x, 1, 5)</code></td>
          <td>è®¡ç®— $\sum_{i=1}^{5} x^2$ (è¡¨è¾¾å¼, å˜é‡, èµ·å§‹, ç»“æŸ)</td>
        </tr>
        <tr>
          <td><strong>å¾®ç§¯åˆ†</strong></td>
          <td><code>d(x^2, x)</code> / <code>int(x^2, x, 0, 1)</code></td>
          <td>æ±‚å¯¼æ•° (Derivative) / å®šç§¯åˆ† (Integral)</td>
        </tr>
        <tr>
          <td><strong>çº¿æ€§ä»£æ•°</strong></td>
          <td><code>det([1, 2; 3, 4])</code></td>
          <td>è®¡ç®—è¡Œåˆ—å¼ (çŸ©é˜µç”¨ <code>;</code> åˆ†è¡Œ)</td>
        </tr>
        <tr>
          <td><strong>çŸ©é˜µè¿ç®—</strong></td>
          <td><code>[1, 2] * [3, 4]'</code></td>
          <td>çŸ©é˜µä¹˜æ³• (<code>'</code> è¡¨ç¤ºè½¬ç½®)</td>
        </tr>
      </table>

      <div style="text-align:center; margin-top:20px; padding-top:10px; border-top:1px solid #eee;">
        <button class="btn btn-primary" onclick="document.getElementById('help-modal').style.display='none'" style="padding: 8px 40px; font-size: 14px;">æˆ‘å­¦ä¼šäº†</button>
      </div>
    </div>
  </div>
</div>

<!-- è®¾ç½®é¢æ¿å¼¹çª— -->
<div id="settings-modal" class="modal-overlay" style="display:none;">
  <div class="modal-content" style="width: 700px; max-height: 85vh;">
    <div class="modal-header" style="border-bottom: 2px solid #3498db; padding-bottom: 10px; margin-bottom: 15px; display:flex; justify-content:space-between; align-items:center;">
      <span style="font-size:18px; font-weight:bold; color:#fff;">âš™ï¸ è®¾ç½®</span>
      <button style="border:none; background:none; cursor:pointer; font-size:24px; color:#999;" onclick="document.getElementById('settings-modal').style.display='none'">Ã—</button>
    </div>

    <div class="settings-panel">
      <!-- æ•°æ®æ–‡ä»¶å¤¹è®¾ç½® -->
      <div class="settings-section">
        <h3>ğŸ“ æ•°æ®æ–‡ä»¶å¤¹</h3>
        <div class="settings-row">
          <label>å½“å‰è·¯å¾„:</label>
          <span id="current-path" style="color:#3498db; font-size:13px;">æœªè®¾ç½®</span>
        </div>
        <div class="settings-row">
          <button id="btn-select-data-folder">é€‰æ‹©æ•°æ®æ–‡ä»¶å¤¹</button>
          <span style="font-size:12px; color:#888;">é€‰æ‹©åå°†è‡ªåŠ¨ä¿å­˜åˆ°æ­¤æ–‡ä»¶å¤¹</span>
        </div>
      </div>

      <!-- åˆ†ç»„ç®¡ç† -->
      <div class="settings-section">
        <h3>ğŸ“‚ åˆ†ç»„ç®¡ç†</h3>
        <p style="color:#888; font-size:13px; margin:0;">
          åœ¨é¡¶éƒ¨ Tab æ ‡ç­¾é¡µä¸­ç®¡ç†åˆ†ç»„ï¼š<br>
          â€¢ ç‚¹å‡» Tab åˆ‡æ¢åˆ†ç»„<br>
          â€¢ åŒå‡» Tab åç§°ä¿®æ”¹<br>
          â€¢ ç‚¹å‡» Ã— åˆ é™¤åˆ†ç»„<br>
          â€¢ ç‚¹å‡» + æ·»åŠ æ–°åˆ†ç»„
        </p>
      </div>

      <!-- ç¼–è¾‘å™¨è®¾ç½® -->
      <div class="settings-section">
        <h3>âœï¸ ç¼–è¾‘å™¨</h3>
        <div class="settings-row">
          <label>å­—å·å¤§å°</label>
          <select id="font-size-select" style="background:#2B2B2B; color:#fff; border:1px solid #555; padding:6px 10px; border-radius:4px; outline:none; cursor:pointer;">
            <option value="14">å° (14px)</option>
            <option value="16">è¾ƒå° (16px)</option>
            <option value="18">ä¸­ç­‰ (18px)</option>
            <option value="20" selected>é»˜è®¤ (20px)</option>
            <option value="22">è¾ƒå¤§ (22px)</option>
            <option value="24">å¤§ (24px)</option>
            <option value="28">ç‰¹å¤§ (28px)</option>
          </select>
        </div>
      </div>

      <!-- è‡ªåŠ¨ä¿å­˜è®¾ç½® -->
      <div class="settings-section">
        <h3>ğŸ’¾ è‡ªåŠ¨ä¿å­˜</h3>
        <div class="settings-row">
          <label>å¯ç”¨è‡ªåŠ¨ä¿å­˜</label>
          <label class="switch">
            <input type="checkbox" id="auto-save-toggle">
            <span class="slider"></span>
          </label>
        </div>
        <div class="settings-row">
          <label>ä¿å­˜é—´éš”(ç§’)</label>
          <input type="number" id="auto-save-interval" value="60" min="10" max="600" style="width:100px;">
        </div>
        <div class="settings-row">
          <label>ä¿ç•™ç‰ˆæœ¬å¤©æ•°</label>
          <input type="number" id="keep-version-days" value="7" min="1" max="365" style="width:100px;">
        </div>
        <div class="settings-row">
          <button id="btn-clean-versions">ç«‹å³æ¸…ç†è¿‡æœŸç‰ˆæœ¬</button>
        </div>
      </div>

      <!-- ä¿å­˜æŒ‰é’® -->
      <div style="text-align:center; margin-top:20px;">
        <button class="btn-close" id="btn-save-settings">ä¿å­˜è®¾ç½®</button>
      </div>
    </div>
  </div>
</div>

<!-- è‡ªå®šä¹‰å¯¹è¯æ¡† -->
<div id="custom-dialog" class="custom-dialog">
  <div class="dialog-box">
    <div class="dialog-title" id="dialog-title">æç¤º</div>
    <div class="dialog-message" id="dialog-message"></div>
    <input type="text" class="dialog-input" id="dialog-input" style="display:none;">
    <div class="dialog-color-picker" id="dialog-color-picker" style="display:none;">
      <label class="dialog-color-label">é€‰æ‹©é¢œè‰²</label>
      <div class="dialog-color-options" id="dialog-color-options"></div>
    </div>
    <div class="dialog-buttons">
      <button class="dialog-btn dialog-btn-secondary" id="dialog-cancel">å–æ¶ˆ</button>
      <button class="dialog-btn dialog-btn-primary" id="dialog-confirm">ç¡®å®š</button>
    </div>
  </div>
</div>

<!-- è½»é‡çº§æ¶ˆæ¯æç¤º -->
<div id="toast-message" class="toast-message"></div>

<!-- æœç´¢æ¡† -->
<div id="search-box" class="search-box">
  <div class="search-box-header">
    <span class="search-box-title">æœç´¢</span>
    <span class="search-box-close" id="search-close">Ã—</span>
  </div>
  <div class="search-input-wrapper">
    <input type="text" class="search-input" id="search-input" placeholder="è¾“å…¥æœç´¢å†…å®¹...">
    <button class="search-nav-btn" id="search-prev">â†‘</button>
    <button class="search-nav-btn" id="search-next">â†“</button>
  </div>
  <div class="search-info" id="search-info">è¾“å…¥å†…å®¹å¼€å§‹æœç´¢</div>
</div>

<!-- === æ ¸å¿ƒé€»è¾‘åŒº === -->
<script>
  // 0. é¢œè‰²é…ç½®
  const COLORS = [
    { name: 'è“è‰²', value: '#3498db' },
    { name: 'ç»¿è‰²', value: '#2ecc71' },
    { name: 'ç´«è‰²', value: '#9b59b6' },
    { name: 'æ©™è‰²', value: '#e67e22' },
    { name: 'çº¢è‰²', value: '#e74c3c' },
    { name: 'é’è‰²', value: '#1abc9c' },
    { name: 'ç²‰è‰²', value: '#e91e63' },
    { name: 'é»„è‰²', value: '#f39c12' },
    { name: 'æ·±è“', value: '#34495e' },
    { name: 'æ·±ç»¿', value: '#27ae60' },
    { name: 'æ·±ç´«', value: '#8e44ad' },
    { name: 'æ·±ç°', value: '#7f8c8d' }
  ];

  // 1. è½»é‡çº§æ¶ˆæ¯æç¤ºå‡½æ•°
  const Toast = {
    show: function(message, duration = 2000) {
      const toast = document.getElementById('toast-message');
      toast.textContent = message;
      toast.classList.add('show');

      // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
      if (this.timer) clearTimeout(this.timer);

      // è®¾ç½®æ–°çš„å®šæ—¶å™¨
      this.timer = setTimeout(() => {
        toast.classList.remove('show');
      }, duration);
    },
    timer: null
  };

  // 1. è‡ªå®šä¹‰å¯¹è¯æ¡†å‡½æ•°
  const CustomDialog = {
    selectedColor: '#3498db',

    show: function(title, message, type = 'alert', defaultValue = '', options = {}) {
      return new Promise((resolve) => {
        const dialog = document.getElementById('custom-dialog');
        const titleEl = document.getElementById('dialog-title');
        const messageEl = document.getElementById('dialog-message');
        const inputEl = document.getElementById('dialog-input');
        const colorPickerEl = document.getElementById('dialog-color-picker');
        const cancelBtn = document.getElementById('dialog-cancel');
        const confirmBtn = document.getElementById('dialog-confirm');

        titleEl.textContent = title;
        messageEl.textContent = message;

        // é‡ç½®é¢œè‰²é€‰æ‹©å™¨
        colorPickerEl.style.display = 'none';
        this.selectedColor = options.defaultColor || '#3498db';

        if(type === 'prompt') {
          inputEl.style.display = 'block';
          inputEl.value = defaultValue;
          cancelBtn.style.display = 'block';

          // å¦‚æœéœ€è¦æ˜¾ç¤ºé¢œè‰²é€‰æ‹©å™¨
          if(options.showColorPicker) {
            this.renderColorPicker(this.selectedColor);
            colorPickerEl.style.display = 'block';
          }

          setTimeout(() => inputEl.focus(), 100);
        } else if(type === 'confirm') {
          inputEl.style.display = 'none';
          cancelBtn.style.display = 'block';
        } else {
          inputEl.style.display = 'none';
          cancelBtn.style.display = 'none';
        }

        dialog.classList.add('show');

        const cleanup = () => {
          dialog.classList.remove('show');
          confirmBtn.onclick = null;
          cancelBtn.onclick = null;
          inputEl.onkeydown = null;
        };

        confirmBtn.onclick = () => {
          cleanup();
          if(type === 'prompt' && options.showColorPicker) {
            resolve({ text: inputEl.value, color: this.selectedColor });
          } else {
            resolve(type === 'prompt' ? inputEl.value : true);
          }
        };

        cancelBtn.onclick = () => {
          cleanup();
          resolve(type === 'prompt' ? null : false);
        };

        if(type === 'prompt') {
          inputEl.onkeydown = (e) => {
            if(e.key === 'Enter') {
              cleanup();
              if(options.showColorPicker) {
                resolve({ text: inputEl.value, color: this.selectedColor });
              } else {
                resolve(inputEl.value);
              }
            } else if(e.key === 'Escape') {
              cleanup();
              resolve(null);
            }
          };
        }
      });
    },
    alert: function(message, title = 'æç¤º') {
      return this.show(title, message, 'alert');
    },
    confirm: function(message, title = 'ç¡®è®¤') {
      return this.show(title, message, 'confirm');
    },
    prompt: function(message, defaultValue = '', title = 'è¾“å…¥', options = {}) {
      return this.show(title, message, 'prompt', defaultValue, options);
    },
    renderColorPicker: function(selectedColor) {
      const container = document.getElementById('dialog-color-options');
      container.innerHTML = '';

      COLORS.forEach(color => {
        const dot = document.createElement('div');
        dot.className = 'dialog-color-dot';
        dot.style.background = color.value;
        dot.title = color.name;

        if (color.value === selectedColor) {
          dot.classList.add('selected');
        }

        dot.onclick = () => {
          this.selectedColor = color.value;
          this.renderColorPicker(color.value);
        };

        container.appendChild(dot);
      });
    }
  };

  // 1. åˆå§‹åŒ– Math.js
  let mathLib = null;
  // --- æ–°å¢ï¼šä¸€é”®æ¸…å±åŠŸèƒ½ ---
  // --- ä¿®æ”¹åï¼šä¸€é”®æ¸…å± (æ–‡å­— + å›¾ç‰‡) ---
document.getElementById('btn-clear').onclick = async () => {
    // æç¤ºè¯­å˜äº†ï¼Œå‘ŠçŸ¥ç”¨æˆ·å›¾ç‰‡ä¹Ÿä¼šæ²¡äº†
    const confirmed = await CustomDialog.confirm("ğŸ’¥ ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†…å®¹å—ï¼Ÿ\n\næ­¤æ“ä½œå°†åˆ é™¤ï¼š\n1. æ‰€æœ‰è‰ç¨¿æ–‡å­—\n2. ä¾§è¾¹æ æ‰€æœ‰å›¾ç‰‡ç´ æ\n\n(ä¸å¯æ’¤é”€ï¼Œè¯·è°¨æ…æ“ä½œ)", "æ¸…ç©ºç¡®è®¤");
    if (confirmed) {
        
        // 1. æ¸…ç©ºæ–‡å­—
        editor.value = "";
        
        // 2. æ¸…ç©ºå›¾ç‰‡ (ä¿ç•™æç¤ºè¯­ï¼Œåˆ é™¤æ‰€æœ‰ img-card)
        const sidebar = document.getElementById('image-sidebar');
        // é‡ç½®ä¸ºåˆå§‹çŠ¶æ€
        sidebar.innerHTML = '<div class="sidebar-tip">Ctrl+V ç²˜è´´å›¾ç‰‡<br>åŒå‡»åœ¨æ–°çª—å£ç¼–è¾‘</div>';
        
        // 3. è‡ªåŠ¨æ”¶èµ·ä¾§è¾¹æ  (å› ä¸ºå®ƒç©ºäº†)
        sidebar.classList.remove('active');

        // 4. ç«‹å³ä¿å­˜ç©ºçŠ¶æ€ & èšç„¦
        saveDraft();
        editor.focus();
        
        // ç»™ä¸ªè½»æç¤º
        Toast.show("å·²æ¸…ç©ºæ‰€æœ‰å†…å®¹");
    }
};
  try {
      if(typeof math !== 'undefined') {
          const { create, all } = math;
          mathLib = create(all);
          // æ³¨å…¥è‡ªå®šä¹‰å‡½æ•°
          const integrate = (expr, v, s, e) => {
              const step=1000, h=(e-s)/step, f=mathLib.compile(expr), sc={};
              let sum=0; sc[v]=s; sum+=f.evaluate(sc); sc[v]=e; sum+=f.evaluate(sc);
              for(let i=1;i<step;i++) { sc[v]=s+i*h; sum+=(i%2===0?2:4)*f.evaluate(sc); }
              return (h/3)*sum;
          };
          const sigma = (expr, v, s, e) => {
              let sum=0, f=mathLib.compile(expr), sc={};
              for(let i=s;i<=e;i++) { sc[v]=i; sum+=f.evaluate(sc); }
              return sum;
          };
          mathLib.import({ d:mathLib.derivative, int:integrate, integral:integrate, sigma:sigma });
      } else {
          alert("é”™è¯¯ï¼šMath.js æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ math.min.js æ–‡ä»¶ï¼");
      }
  } catch(e) { console.error(e); }

  // ç¬¦å·æ˜ å°„
  const superscriptMap = { '0': 'â°', '1': 'Â¹', '2': 'Â²', '3': 'Â³', '4': 'â´', '5': 'âµ', '6': 'â¶', '7': 'â·', '8': 'â¸', '9': 'â¹', '+': 'âº', '-': 'â»', '(': 'â½', ')': 'â¾', 'n': 'â¿', '.': 'Ë™' };
  const reverseSuperscriptMap = Object.fromEntries(Object.entries(superscriptMap).map(([k, v]) => [v, k]));

  // MathLogic å·¥å…·å¯¹è±¡
  const MathLogic = {
      calculate: (input) => {
          if (!input || !input.trim() || !mathLib) return null;
          let clean = MathLogic.normalize(input);
          try {
              let res = mathLib.evaluate(clean);
              if (res !== undefined) {
                  let str = res.toString();
                  if (typeof res === 'number' && !Number.isInteger(res)) str = parseFloat(res.toFixed(4)).toString();
                  if (res.type === 'Unit') str = ' ' + str;
                  return str;
              }
          } catch (e) {}
          try {
              let fuzzy = clean.replace(/[^0-9+\-*/().%^a-zA-Z]/g, ''); 
              if (fuzzy && !/^[0-9.]+$/.test(fuzzy)) return mathLib.evaluate(fuzzy).toString();
          } catch (e) {}
          return null;
      },
      normalize: (s) => {
          s = s.replace(/Ã—/g, '*').replace(/Ã·/g, '/').replace(/Ï€/g, 'pi').replace(/âˆš/g, 'sqrt').replace(/â‰¤/g, '<=').replace(/â‰¥/g, '>=').replace(/â‰ /g, '!=');
          const supRegex = new RegExp(`[${Object.values(superscriptMap).join('')}]+`, 'g');
          s = s.replace(supRegex, (m) => '^' + m.split('').map(c => reverseSuperscriptMap[c]).join(''));
          return s.replace(/\^([+\-]\d+)/g, '^($1)').replace(/ï¼ˆ/g, '(').replace(/ï¼‰/g, ')').replace(/ï¼/g, '=').split('=')[0]; 
      },
      toSuperscript: (str) => {
          let c = ""; for (let char of str) c += superscriptMap[char] || char; return c;
      }
  };

  // 2. ä¸» UI é€»è¾‘
  const editor = document.getElementById('editor');
  const sidebar = document.getElementById('image-sidebar');
  const DB_ID = 'science_draft_v4';
  let isResultSelected = false;

  // æ–°å¢ï¼šå…¨å±€é…ç½®å˜é‡
  let appConfig = null;
  let currentGroupData = { text: '', images: [] };

  // è¾“å…¥äº‹ä»¶
  editor.addEventListener('input', (e) => {
      saveDraft();
      // è®¡ç®—
      if (e.data === '=' || e.data === 'ï¼') {
          const end = editor.selectionEnd;
          const text = editor.value.substring(0, end);
          const line = text.substring(text.lastIndexOf('\n') + 1, end - 1);
          const res = MathLogic.calculate(line);
          if (res) {
              editor.setRangeText(res.startsWith(' ')?res:(' '+res), end, end, 'select');
              isResultSelected = true;
          }
          return;
      }
      isResultSelected = false;
      // ç¬¦å·æ›¿æ¢
      if (e.inputType && e.inputType.startsWith("insert")) {
          const end = editor.selectionEnd;
          const val = editor.value;
          const before = val.substring(0, end);
          const after = val.substring(end);
          let n = val, off = 0;
          if (before.endsWith('*')) { n = before.slice(0,-1)+'Ã—'+after; }
          else if (before.endsWith('/')) { n = before.slice(0,-1)+'Ã·'+after; }
          else if (before.endsWith('pi')) { n = before.slice(0,-2)+'Ï€'+after; off=-1; }
          else if (before.endsWith('sqrt')) { n = before.slice(0,-4)+'âˆš'+after; off=-3; }
          if (n !== val) { editor.value = n; editor.selectionStart = end+off; editor.selectionEnd = end+off; saveDraft(); }
      }
  });

  // æŒ‰é”®äº‹ä»¶
  editor.addEventListener('keydown', (e) => {
      // Ctrl+S (Windows/Linux) æˆ– Cmd+S (macOS) ä¿å­˜
      if ((e.ctrlKey || e.metaKey) && e.key === 's') {
          e.preventDefault();
          saveToCurrentGroup();
          return;
      }

      // Ctrl+F (Windows/Linux) æˆ– Cmd+F (macOS) æœç´¢
      if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
          e.preventDefault();
          openSearchBox();
          return;
      }

      if (e.key === 'Tab') {
          if (isResultSelected) { e.preventDefault(); editor.selectionStart = editor.selectionEnd; isResultSelected = false; }
          else { e.preventDefault(); document.execCommand('insertText', false, '\t'); }
      }
      if (e.key === ' ') {
          const end = editor.selectionEnd;
          const match = editor.value.substring(0, end).match(/\^([0-9+\-n().]+)$/);
          if (match) {
              e.preventDefault();
              const conv = MathLogic.toSuperscript(match[1]);
              editor.setRangeText(conv + ' ', end - match[0].length, end, 'end');
              saveDraft();
          }
      }
  });

  // æ–°å¢ï¼šä¿å­˜åˆ°å½“å‰åˆ†ç»„
  document.getElementById('btn-save').onclick = () => {
      saveToCurrentGroup();
  };

  function addImageToSidebar(src) {
      const div = document.createElement('div'); div.className = 'img-card';
      const id = Date.now() + Math.random().toString(36).substr(2, 5);
      div.innerHTML = `<img src="${src}" data-id="${id}"><div class="del-btn">Ã—</div><div class="edit-hint">åŒå‡»ç¼–è¾‘</div>`;
      div.ondblclick = () => {
          if(!window.utools) return;
          localStorage.setItem('utools_paint_request', JSON.stringify({id, src}));
          utools.createBrowserWindow('editor.html', { title: 'ç»˜å›¾æ¿', width: 1000, height: 800, resizable: true, webPreferences: {nodeIntegration: true} });
      };
      div.querySelector('.del-btn').onclick = (e) => { e.stopPropagation(); div.remove(); saveDraft(); };
      sidebar.appendChild(div);
  }

  window.addEventListener('storage', (e) => {
      if (e.key === 'utools_paint_finished') {
          const p = JSON.parse(e.newValue);
          const img = document.querySelector(`img[data-id="${p.id}"]`);
          if(img) { 
              img.src = p.data; 
              saveDraft(); 
              img.parentElement.style.border="2px solid #2ecc71";
              setTimeout(()=>img.parentElement.style.border="2px solid transparent", 1000);
          }
          localStorage.removeItem('utools_paint_finished');
      }
  });

  document.addEventListener('paste', (e) => {
      const items = (e.clipboardData || e.originalEvent.clipboardData).items;
      for (let i in items) {
          if (items[i].kind === 'file' && items[i].type.includes('image/')) {
              const reader = new FileReader();
              reader.onload = (evt) => { addImageToSidebar(evt.target.result); saveDraft(); sidebar.classList.add('active'); };
              reader.readAsDataURL(items[i].getAsFile());
          }
      }
  });

  document.getElementById('btn-sidebar').onclick = () => sidebar.classList.toggle('active');
  document.getElementById('btn-help').onclick = () => document.getElementById('help-modal').style.display = 'flex';

  function saveDraft() {
     if(!window.utools) return;
     const imgs = []; document.querySelectorAll('#image-sidebar img').forEach(i => imgs.push(i.src));
     utools.db.put({ _id: DB_ID, data: { text: editor.value, images: imgs }, _rev: utools.db.get(DB_ID)?._rev });
  }

  // æ–°å¢ï¼šä¿å­˜åˆ°å½“å‰åˆ†ç»„
  async function saveToCurrentGroup() {
      if(!window.services || !window.AppConfig) {
          await CustomDialog.alert("æ’ä»¶é”™è¯¯: æ¨¡å—æœªåŠ è½½");
          return;
      }
      const config = window.AppConfig.getConfig();

      if(!config.initialized || !config.dataFolderPath) {
          await CustomDialog.alert("è¯·å…ˆåœ¨è®¾ç½®ä¸­é€‰æ‹©æ•°æ®æ–‡ä»¶å¤¹");
          document.getElementById('settings-modal').style.display = 'flex';
          return;
      }

      const imgs = [];
      document.querySelectorAll('#image-sidebar img').forEach(i => imgs.push(i.src));
      const res = window.services.saveToGroup(config.dataFolderPath, config.currentGroup, editor.value, imgs);

      if(res.success) {
          Toast.show(`å·²ä¿å­˜åˆ°åˆ†ç»„: ${config.currentGroup}`);
          window.AutoSave.updateLastSavedHash(editor.value, imgs);
      } else {
          await CustomDialog.alert("ä¿å­˜å¤±è´¥: " + res.error);
      }
  }
  // æ–°å¢ï¼šä»å½“å‰åˆ†ç»„åŠ è½½æ•°æ®
  function loadFromCurrentGroup() {
      if(!window.services || !window.AppConfig) return;
      const config = window.AppConfig.getConfig();

      if(!config.initialized || !config.dataFolderPath) {
          loadDraft(); // å›é€€åˆ°æ—§ç‰ˆæœ¬åŠ è½½
          return;
      }

      const res = window.services.loadFromGroup(config.dataFolderPath, config.currentGroup);
      if(res.success) {
          editor.value = res.data.text || '';
          sidebar.innerHTML = '<div class="sidebar-tip">Ctrl+V ç²˜è´´å›¾ç‰‡<br>åŒå‡»åœ¨æ–°çª—å£ç¼–è¾‘</div>';
          res.data.images.forEach(addImageToSidebar);
          if(res.data.images.length) sidebar.classList.add('active');
          window.AutoSave.updateLastSavedHash(editor.value, res.data.images);
      }
  }

  function loadDraft() {
     editor.placeholder = "æ—§ç‰ˆæœ¬åŠ è½½";
     if(!window.utools) return;
     const doc = utools.db.get(DB_ID);
     if(doc && doc.data) {
         editor.value = doc.data.text||'';
         (doc.data.images||[]).forEach(addImageToSidebar);
         if(doc.data.images?.length) sidebar.classList.add('active');
     } else { document.getElementById('help-modal').style.display = 'flex'; }
  }
  // æ–°å¢ï¼šæ›´æ–° Tab æ ‡ç­¾é¡µ
  function updateTabs() {
      const config = window.AppConfig.getConfig();
      const container = document.getElementById('tabs-container');

      // ç¡®ä¿ groupColors å­˜åœ¨
      if (!config.groupColors) {
          config.groupColors = {};
      }

      // æ¸…ç©ºç°æœ‰ tabs
      container.innerHTML = '';

      // åˆ›å»ºæ‰€æœ‰åˆ†ç»„çš„ tab
      config.groups.forEach(group => {
          const tab = document.createElement('div');
          tab.className = 'tab';
          if(group === config.currentGroup) tab.classList.add('active');
          tab.dataset.group = group;

          // åº”ç”¨é¢œè‰²
          const color = config.groupColors[group] || '#3498db';
          if(group === config.currentGroup) {
              // æ¿€æ´»çŠ¶æ€ï¼šå®Œå…¨ä¸é€æ˜
              tab.style.background = color;
              tab.style.borderColor = color;
          } else {
              // æœªæ¿€æ´»çŠ¶æ€ï¼šåŠé€æ˜
              tab.style.background = color + '40'; // æ·»åŠ 40è¡¨ç¤º25%é€æ˜åº¦
              tab.style.borderColor = color + '40';
          }

          tab.innerHTML = `
              <span class="tab-name">${group}</span>
              <span class="tab-close">Ã—</span>
          `;
          container.appendChild(tab);
      });

      // ç»‘å®šäº‹ä»¶
      bindTabEvents();
  }

  // æ–°å¢ï¼šç»‘å®š Tab äº‹ä»¶
  function bindTabEvents() {
      const tabs = document.querySelectorAll('.tab');
      tabs.forEach(tab => {
          const closeBtn = tab.querySelector('.tab-close');

          // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          const newCloseBtn = closeBtn.cloneNode(true);
          closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn);

          // ç‚¹å‡»æ•´ä¸ª tab åˆ‡æ¢åˆ†ç»„ï¼ˆè‡ªåŠ¨ä¿å­˜ï¼‰
          tab.addEventListener('click', (e) => {
              // å¦‚æœç‚¹å‡»çš„æ˜¯å…³é—­æŒ‰é’®ï¼Œä¸è§¦å‘åˆ‡æ¢
              if(e.target.classList.contains('tab-close')) {
                  return;
              }
              const groupName = tab.dataset.group;
              if(groupName !== window.AppConfig.getConfig().currentGroup) {
                  saveToCurrentGroup(); // åˆ‡æ¢å‰ä¿å­˜
                  window.AppConfig.switchGroup(groupName);
                  updateTabs();
                  loadFromCurrentGroup();
                  Toast.show(`å·²åˆ‡æ¢åˆ°: ${groupName}`);
              }
          });

          // åŒå‡»ä¿®æ”¹åç§°å’Œé¢œè‰²
          tab.addEventListener('dblclick', async (e) => {
              // å¦‚æœç‚¹å‡»çš„æ˜¯å…³é—­æŒ‰é’®ï¼Œä¸è§¦å‘é‡å‘½å
              if(e.target.classList.contains('tab-close')) {
                  return;
              }
              e.stopPropagation();
              const oldName = tab.dataset.group;
              const config = window.AppConfig.getConfig();
              const currentColor = config.groupColors[oldName] || '#3498db';

              const result = await CustomDialog.prompt('ä¿®æ”¹åˆ†ç»„åç§°:', oldName, 'é‡å‘½ååˆ†ç»„', {
                  showColorPicker: true,
                  defaultColor: currentColor
              });

              if(result && result.text && result.text.trim() && result.text !== oldName) {
                  renameGroup(oldName, result.text.trim(), result.color);
              } else if(result && result.color !== currentColor) {
                  // åªä¿®æ”¹é¢œè‰²
                  config.groupColors[oldName] = result.color;
                  window.AppConfig.setConfig(config);
                  updateTabs();
                  Toast.show('é¢œè‰²å·²æ›´æ–°');
              }
          });

          // ç‚¹å‡»å…³é—­æŒ‰é’®
          newCloseBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              const groupName = tab.dataset.group;
              window.deleteGroup(groupName);
          });
      });
  }

  // æ–°å¢ï¼šé‡å‘½ååˆ†ç»„
  async function renameGroup(oldName, newName, newColor) {
      const config = window.AppConfig.getConfig();
      if(config.groups.includes(newName)) {
          await CustomDialog.alert('åˆ†ç»„åç§°å·²å­˜åœ¨');
          return;
      }
      const index = config.groups.indexOf(oldName);
      if(index !== -1) {
          config.groups[index] = newName;
          if(config.currentGroup === oldName) {
              config.currentGroup = newName;
          }

          // æ›´æ–°é¢œè‰²æ˜ å°„
          if(newColor) {
              config.groupColors[newName] = newColor;
          } else if(config.groupColors[oldName]) {
              config.groupColors[newName] = config.groupColors[oldName];
          }
          delete config.groupColors[oldName];

          window.AppConfig.setConfig(config);

          // é‡å‘½åæ–‡ä»¶å¤¹
          if(config.dataFolderPath) {
              const oldPath = require('path').join(config.dataFolderPath, oldName);
              const newPath = require('path').join(config.dataFolderPath, newName);
              if(require('fs').existsSync(oldPath)) {
                  require('fs').renameSync(oldPath, newPath);
              }
          }

          updateTabs();
          Toast.show(`å·²é‡å‘½å: ${oldName} â†’ ${newName}`);
      }
  }

  // æ–°å¢ï¼šæœç´¢åŠŸèƒ½
  const SearchBox = {
    matches: [],
    currentIndex: -1,

    open: function() {
      document.getElementById('search-box').classList.add('show');
      const input = document.getElementById('search-input');
      input.focus();
      input.select();
    },

    close: function() {
      document.getElementById('search-box').classList.remove('show');
      this.clearHighlights();
      editor.focus();
    },

    search: function(keyword) {
      this.clearHighlights();
      this.matches = [];
      this.currentIndex = -1;

      if (!keyword) {
        document.getElementById('search-info').textContent = 'è¾“å…¥å†…å®¹å¼€å§‹æœç´¢';
        return;
      }

      const text = editor.value;
      const lowerText = text.toLowerCase();
      const lowerKeyword = keyword.toLowerCase();
      let pos = 0;

      while ((pos = lowerText.indexOf(lowerKeyword, pos)) !== -1) {
        this.matches.push(pos);
        pos += keyword.length;
      }

      if (this.matches.length > 0) {
        document.getElementById('search-info').textContent = `æ‰¾åˆ° ${this.matches.length} ä¸ªç»“æœ`;
        this.currentIndex = 0;
        this.highlightCurrent();
      } else {
        document.getElementById('search-info').textContent = 'æœªæ‰¾åˆ°åŒ¹é…é¡¹';
      }
    },

    next: function() {
      if (this.matches.length === 0) return;
      this.currentIndex = (this.currentIndex + 1) % this.matches.length;
      this.highlightCurrent();
    },

    prev: function() {
      if (this.matches.length === 0) return;
      this.currentIndex = (this.currentIndex - 1 + this.matches.length) % this.matches.length;
      this.highlightCurrent();
    },

    highlightCurrent: function() {
      if (this.currentIndex < 0 || this.currentIndex >= this.matches.length) return;
      const pos = this.matches[this.currentIndex];
      const keyword = document.getElementById('search-input').value;
      editor.focus();
      editor.setSelectionRange(pos, pos + keyword.length);
      editor.scrollTop = editor.scrollHeight * (pos / editor.value.length) - editor.clientHeight / 2;
      document.getElementById('search-info').textContent = `${this.currentIndex + 1} / ${this.matches.length}`;
    },

    clearHighlights: function() {
      // æ¸…é™¤é€‰ä¸­çŠ¶æ€
      if (editor === document.activeElement) {
        const pos = editor.selectionStart;
        editor.setSelectionRange(pos, pos);
      }
    }
  };

  function openSearchBox() {
    SearchBox.open();
  }

  // æœç´¢æ¡†äº‹ä»¶ç»‘å®š
  document.getElementById('search-close').onclick = () => SearchBox.close();
  document.getElementById('search-input').addEventListener('input', (e) => {
    SearchBox.search(e.target.value);
  });
  document.getElementById('search-input').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      if (e.shiftKey) {
        SearchBox.prev();
      } else {
        SearchBox.next();
      }
    } else if (e.key === 'Escape') {
      SearchBox.close();
    }
  });
  document.getElementById('search-prev').onclick = () => SearchBox.prev();
  document.getElementById('search-next').onclick = () => SearchBox.next();

  // æ–°å¢ï¼šåŠ å·æŒ‰é’®äº‹ä»¶
  document.getElementById('tab-add').addEventListener('click', async () => {
      const result = await CustomDialog.prompt('è¾“å…¥æ–°åˆ†ç»„åç§°:', '', 'æ·»åŠ åˆ†ç»„', {
          showColorPicker: true,
          defaultColor: '#3498db'
      });

      if(result && result.text && result.text.trim()) {
          const config = window.AppConfig.getConfig();
          const res = window.AppConfig.addGroup(result.text.trim());
          if(res.success) {
              if(config.dataFolderPath) {
                  window.services.createGroup(config.dataFolderPath, result.text.trim());
              }

              // ä¿å­˜é¢œè‰²
              const updatedConfig = window.AppConfig.getConfig();
              updatedConfig.groupColors[result.text.trim()] = result.color;
              window.AppConfig.setConfig(updatedConfig);
              updateTabs();
              Toast.show(`åˆ†ç»„ "${result.text.trim()}" å·²æ·»åŠ `);
          } else {
              await CustomDialog.alert(res.error);
          }
      }
  });

  // æ–°å¢ï¼šå¯åŠ¨è‡ªåŠ¨ä¿å­˜
  function startAutoSave() {
      const config = window.AppConfig.getConfig();
      window.AutoSave.start(config.autoSaveInterval, () => {
          const imgs = [];
          document.querySelectorAll('#image-sidebar img').forEach(i => imgs.push(i.src));
          if(window.AutoSave.hasContentChanged(editor.value, imgs)) {
              saveToCurrentGroup();
          }
      });
  }


  // æ–°å¢ï¼šæ‰“å¼€è®¾ç½®é¢æ¿
  document.getElementById('btn-settings').onclick = () => {
      openSettingsPanel();
  };

  // æ–°å¢ï¼šæ‰“å¼€è®¾ç½®é¢æ¿å‡½æ•°
  function openSettingsPanel() {
      const config = window.AppConfig.getConfig();

      // æ›´æ–°å½“å‰è·¯å¾„æ˜¾ç¤º
      document.getElementById('current-path').textContent = config.dataFolderPath || 'æœªè®¾ç½®';

      // æ›´æ–°å­—å·è®¾ç½®
      document.getElementById('font-size-select').value = config.fontSize || 20;

      // æ›´æ–°è‡ªåŠ¨ä¿å­˜è®¾ç½®
      document.getElementById('auto-save-toggle').checked = config.autoSave;
      document.getElementById('auto-save-interval').value = config.autoSaveInterval;
      document.getElementById('keep-version-days').value = config.keepVersionDays;

      // æ˜¾ç¤ºè®¾ç½®é¢æ¿
      document.getElementById('settings-modal').style.display = 'flex';
  }

  // æ–°å¢ï¼šé€‰æ‹©æ•°æ®æ–‡ä»¶å¤¹
  document.getElementById('btn-select-data-folder').onclick = () => {
      const path = window.services.selectFolder();
      if(path) {
          window.AppConfig.initializeDataFolder(path);
          document.getElementById('current-path').textContent = path;
          updateTabs(); // æ›´æ–° Tab æ˜¾ç¤º
          Toast.show('æ•°æ®æ–‡ä»¶å¤¹è®¾ç½®æˆåŠŸ');
      }
  };

  // æ–°å¢ï¼šåˆ é™¤åˆ†ç»„ï¼ˆå…¨å±€å‡½æ•°ï¼‰
  window.deleteGroup = async (groupName) => {
      const confirmed = await CustomDialog.confirm(`ç¡®å®šè¦åˆ é™¤åˆ†ç»„ "${groupName}" å—ï¼Ÿ\n\næ­¤æ“ä½œå°†åˆ é™¤è¯¥åˆ†ç»„çš„æ‰€æœ‰æ•°æ®æ–‡ä»¶ï¼`, 'åˆ é™¤ç¡®è®¤');
      if(!confirmed) {
          return;
      }
      saveToCurrentGroup(); // åˆ é™¤å‰ä¿å­˜å½“å‰åˆ†ç»„
      const config = window.AppConfig.getConfig();
      window.services.deleteGroup(config.dataFolderPath, groupName);
      const res = window.AppConfig.removeGroup(groupName);
      if(res.success) {
          updateTabs();
          loadFromCurrentGroup();
          Toast.show(`åˆ†ç»„ "${groupName}" å·²åˆ é™¤`);
      } else {
          await CustomDialog.alert(res.error);
      }
  };

  // æ–°å¢ï¼šä¿å­˜è®¾ç½®
  document.getElementById('btn-save-settings').onclick = () => {
      const autoSave = document.getElementById('auto-save-toggle').checked;
      const interval = parseInt(document.getElementById('auto-save-interval').value);
      const keepDays = parseInt(document.getElementById('keep-version-days').value);
      const fontSize = parseInt(document.getElementById('font-size-select').value);

      window.AppConfig.updateConfig({
          autoSave: autoSave,
          autoSaveInterval: interval,
          keepVersionDays: keepDays,
          fontSize: fontSize
      });

      // åº”ç”¨å­—å·è®¾ç½®
      editor.style.fontSize = fontSize + 'px';

      // é‡å¯è‡ªåŠ¨ä¿å­˜
      window.AutoSave.stop();
      if(autoSave) {
          startAutoSave();
      }

      document.getElementById('settings-modal').style.display = 'none';
      Toast.show('è®¾ç½®å·²ä¿å­˜');
  };

  // æ–°å¢ï¼šæ¸…ç†è¿‡æœŸç‰ˆæœ¬
  document.getElementById('btn-clean-versions').onclick = async () => {
      const config = window.AppConfig.getConfig();
      if(!config.initialized || !config.dataFolderPath) {
          await CustomDialog.alert('è¯·å…ˆè®¾ç½®æ•°æ®æ–‡ä»¶å¤¹');
          return;
      }
      const res = window.services.cleanOldVersions(config.dataFolderPath, config.keepVersionDays);
      if(res.success) {
          Toast.show(`å·²æ¸…ç† ${res.cleaned} ä¸ªè¿‡æœŸæ–‡ä»¶`);
      } else {
          await CustomDialog.alert('æ¸…ç†å¤±è´¥: ' + res.error);
      }
  };

  // æ–°å¢ï¼šåˆå§‹åŒ–åº”ç”¨é…ç½®
  async function initializeApp() {
      if(!window.AppConfig) return;
      appConfig = window.AppConfig.getConfig();

      // åº”ç”¨å­—å·è®¾ç½®
      editor.style.fontSize = (appConfig.fontSize || 20) + 'px';

      // æ£€æŸ¥æ˜¯å¦é¦–æ¬¡ä½¿ç”¨æˆ–æ•°æ®æ–‡ä»¶å¤¹ä¸å­˜åœ¨
      if(!appConfig.initialized || !appConfig.dataFolderPath) {
          // é¦–æ¬¡ä½¿ç”¨ï¼Œæç¤ºé€‰æ‹©æ•°æ®æ–‡ä»¶å¤¹
          setTimeout(async () => {
              const confirmed = await CustomDialog.confirm('æ¬¢è¿ä½¿ç”¨æ™ºèƒ½ç†ç§‘è‰ç¨¿æœ¬ï¼\n\næ£€æµ‹åˆ°æ‚¨è¿˜æœªè®¾ç½®æ•°æ®æ–‡ä»¶å¤¹ã€‚\næ˜¯å¦ç°åœ¨é€‰æ‹©æ•°æ®æ–‡ä»¶å¤¹ï¼Ÿ\n\nï¼ˆå¯ç¨ååœ¨è®¾ç½®ä¸­é…ç½®ï¼‰', 'é¦–æ¬¡è®¾ç½®');
              if(confirmed) {
                  const path = window.services.selectFolder();
                  if(path) {
                      window.AppConfig.initializeDataFolder(path);
                      appConfig = window.AppConfig.getConfig();
                      updateTabs();
                      Toast.show('æ•°æ®æ–‡ä»¶å¤¹è®¾ç½®æˆåŠŸ');
                  }
              }
          }, 500);
      }

      // æ›´æ–° Tab æ ‡ç­¾é¡µ
      updateTabs();

      // åŠ è½½å½“å‰åˆ†ç»„æ•°æ®
      loadFromCurrentGroup();

      // å¯åŠ¨è‡ªåŠ¨ä¿å­˜
      if(appConfig.autoSave && appConfig.initialized) {
          startAutoSave();
      }

      // æ¸…ç†è¿‡æœŸç‰ˆæœ¬
      if(appConfig.initialized && appConfig.dataFolderPath) {
          window.services.cleanOldVersions(appConfig.dataFolderPath, appConfig.keepVersionDays);
      }
  }

  // æ–°å¢ï¼šæ’ä»¶é€€å‡ºæ—¶è‡ªåŠ¨ä¿å­˜
  if(window.utools) {
      utools.onPluginOut(() => {
          saveToCurrentGroup();
      });
      utools.onPluginEnter(() => {
          editor.focus();
          initializeApp();
      });
  } else {
      initializeApp();
  }
</script>
</body>
</html>
