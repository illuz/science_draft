<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <!-- <title>æ™ºèƒ½ç†ç§‘è‰ç¨¿æœ¬ Ultimate</title> -->
  
  <!-- 1. å¼ºåˆ¶å…¼å®¹ä»£ç ï¼šç¡®ä¿ math.js èƒ½æ³¨å…¥åˆ° window -->
  <script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>
  <script src="math.min.js"></script>
  <script>if (window.module) module = window.module;</script>

  <style>
    /* === å…¨å±€æ·±è‰²ä¸»é¢˜ === */
    body, html { margin: 0; padding: 0; height: 100%; font-family: "Consolas", "Microsoft YaHei", sans-serif; background: #303133; color: #E0E0E0; overflow: hidden; }
    
    /* 1. é¡¶éƒ¨æ ‡é¢˜æ  (æ–°é…è‰² #5D5950) */
    .header {
      height: 50px;
      background: #5D5950;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      user-select: none;
      z-index: 10;
      position: relative;
    }
    .header-title { font-size: 16px; font-weight: bold; color: #fff; letter-spacing: 1px; opacity: 0.9; }
    .menu-btn { cursor: pointer; font-size: 24px; color: #ddd; transition: 0.2s; }
    .menu-btn:hover { color: #fff; transform: scale(1.1); }

    /* 2. ä¸»å®¹å™¨ */
    .main-container { display: flex; height: calc(100% - 50px); position: relative; }
    
    /* 3. ç¼–è¾‘å™¨ (èå…¥èƒŒæ™¯ï¼Œå»é™¤è¾¹æ¡†) */
    #editor {
      flex: 1;
      height: 100%;
      padding: 30px;
      padding-bottom: 80px; /* ç»™åº•éƒ¨å·¥å…·æ ç•™å‡ºç©ºé—´ */
      border: none;
      resize: none;
      outline: none;
      font-size: 20px;
      line-height: 1.8;
      box-sizing: border-box;
      background: #303133;
      color: #E0E0E0;
      font-family: inherit;
    }
    /* é€‰ä¸­æ–‡å­—é¢œè‰² */
    ::selection { background-color: #5D5950; color: #fff; }
    /* æ»šåŠ¨æ¡æ·±è‰²åŒ– */
    ::-webkit-scrollbar { width: 8px; background: #303133; }
    ::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }

    /* 4. åº•éƒ¨æ‚¬æµ®å·¥å…·æ  (æ ¸å¿ƒæ–°å¢æ ·å¼) */
    .bottom-bar {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 25px;
      background: rgba(0, 0, 0, 0.3); /* åŠé€æ˜é»‘åº• */
      padding: 10px 30px;
      border-radius: 30px;
      backdrop-filter: blur(5px);
      z-index: 100;
      transition: all 0.3s;
    }
    .bottom-bar:hover { background: rgba(0, 0, 0, 0.6); }

    .icon-btn {
      width: 40px;   /* å®šä¹‰æŒ‰é’®åŒºåŸŸå¤§å° */
      height: 40px;
      cursor: pointer;
      transition: 0.2s;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }/* å›¾ç‰‡æ ·å¼æ§åˆ¶ */
    .icon-btn img {
      width: 24px;   /* å›¾æ ‡æ˜¾ç¤ºå¤§å° */
      height: 24px;
      opacity: 0.6;  /* é»˜è®¤ç¨å¾®æš—ä¸€ç‚¹ */
      /* filter: invert(1); */ /* å¦‚æœä½ çš„å›¾æ ‡æ˜¯çº¯é»‘è‰²çš„ï¼Œå–æ¶ˆè¿™è¡Œçš„æ³¨é‡ŠæŠŠå®ƒå˜ç™½ */
      transition: all 0.2s;
    }

    /* æ‚¬åœæ•ˆæœ */
    .icon-btn:hover {
      transform: translateY(-3px); /* å‘ä¸Šæµ®åŠ¨ */
    }
    
    .icon-btn:hover img {
      opacity: 1; /* å˜äº® */
    }

    /* æ‚¬åœæç¤ºæ–‡å­—ä½ç½®å¾®è°ƒ */
    .icon-btn:hover::after {
      content: attr(data-tip);
      position: absolute;
      top: -35px;
      background: #000;
      color: #fff;
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 4px;
      white-space: nowrap;
    }
    .icon-btn:hover { color: #fff; transform: translateY(-3px); }
    /* é¼ æ ‡æ‚¬åœæç¤º */
    .icon-btn:hover::after {
      content: attr(data-tip);
      position: absolute;
      top: -35px;
      background: #000;
      color: #fff;
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 4px;
      white-space: nowrap;
    }

    /* 5. ä¾§è¾¹æ  (æ·±è‰² #2B2B2B) */
    #image-sidebar {
      width: 0;
      background: #2B2B2B;
      border-left: 1px solid #444;
      overflow-y: auto;
      transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0;
      z-index: 20;
    }
    #image-sidebar.active { width: 300px; padding: 15px; }
    
    .sidebar-tip { font-size:12px; color:#666; margin:20px 0; text-align:center; width:100%; }

    /* å›¾ç‰‡å¡ç‰‡æ·±è‰²é€‚é… */
    .img-card {
      width: 100%;
      background: #3c3f41;
      margin-bottom: 15px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      position: relative;
      border: 2px solid transparent;
      cursor: zoom-in;
      overflow: hidden;
      transition: 0.2s;
    }
    .img-card:hover { border-color: #888; transform: scale(1.02); }
    .img-card img { width: 100%; display: block; pointer-events: none; }
    .img-card .del-btn {
      position: absolute; top: 5px; right: 5px; width: 22px; height: 22px;
      background: rgba(0,0,0,0.6); color: #fff; border-radius: 50%;
      text-align: center; line-height: 20px; display: none; font-size: 14px;
      cursor: pointer;
      color: white; /* ç¡®ä¿å‰å·æ˜¯ç™½è‰² */
    }
    .img-card:hover .del-btn { display: block; }

    /* 6. å¸®åŠ©å¼¹çª— (æ·±è‰²é€‚é…) */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; display: flex; align-items: center; justify-content: center; }
    .modal-content { background: #3c3f41; color: #eee; padding: 25px; border-radius: 12px; width: 600px; max-height: 85vh; overflow-y: auto; box-shadow: 0 15px 50px rgba(0,0,0,0.5); border: 1px solid #555; }
    
    table { width:100%; font-size:13px; border-collapse: collapse; margin-top:10px; color: #ccc; }
    th, td { padding:8px; border-bottom:1px solid #555; text-align:left; }
    th { background:#333; color: #fff; }
    code { background: #222; padding: 2px 5px; border-radius: 3px; color: #e67e22; font-family: "Consolas"; }
    .key-tag { border: 1px solid #666; padding: 1px 6px; border-radius: 4px; font-size: 12px; background: #444; color: #fff; }
    
    .btn-close {
      background: #5D5950; color: #fff; border: none; padding: 8px 30px; border-radius: 4px; cursor: pointer; margin-top: 20px; transition: 0.2s;
    }
    .btn-close:hover { background: #777265; }
  </style>
</head>
<body>

<div class="toolbar">
    <!-- <div class="toolbar-title">ğŸ“ æ™ºèƒ½ç†ç§‘è‰ç¨¿æœ¬</div> -->
  <!-- é¡¶éƒ¨ Header -->
<div class="header">
  <div class="header-title">è®¡ç®—å…¬å¼</div>
  <!-- å¸®åŠ©æŒ‰é’®ç§»åˆ°äº†è¿™é‡Œ -->
  <div class="menu-btn" id="btn-help" title="å¸®åŠ©/èœå•">â‰¡</div>
</div>
  </div>
</div>

<div class="main-container">
    <!-- åº•éƒ¨æ‚¬æµ®å·¥å…·æ  -->
<div class="bottom-bar">
  <!-- æ¸…å± -->
  <div class="icon-btn" id="btn-clear" data-tip="æ¸…ç©º">
    <!-- è¯·ç¡®ä¿æ‚¨çš„ icons æ–‡ä»¶å¤¹é‡Œæœ‰ clear.png -->
    <img src="icons/clear.png" alt="æ¸…ç©º">
  </div>
  
  <!-- ç´ ææ å¼€å…³ -->
  <div class="icon-btn" id="btn-sidebar" data-tip="ç´ ææ ">
    <img src="icons/image.png" alt="ç´ æ">
  </div>
  
  <!-- å­˜ä¸ºæ–‡ä»¶å¤¹ -->
  <div class="icon-btn" id="btn-save-folder" data-tip="å­˜ä¸ºæ–‡ä»¶å¤¹">
    <img src="icons/save.png" alt="ä¿å­˜">
  </div>
  
  <!-- æ‰“å¼€æ–‡ä»¶å¤¹ -->
  <div class="icon-btn" id="btn-open-folder" data-tip="æ‰“å¼€æ–‡ä»¶å¤¹">
    <img src="icons/folder.png" alt="æ‰“å¼€">
  </div>
</div>
  <textarea id="editor" placeholder="æ­£åœ¨åŠ è½½..."></textarea>
  <div id="image-sidebar">
    <div class="sidebar-tip">Ctrl+V ç²˜è´´å›¾ç‰‡<br>åŒå‡»åœ¨æ–°çª—å£ç¼–è¾‘</div>
  </div> 
</div>

<!-- å‡çº§ç‰ˆå¸®åŠ©å¼¹çª— -->
<div id="help-modal" class="modal-overlay" style="display:none;">
  <div class="modal-content" style="width: 680px; max-height: 85vh; display:flex; flex-direction:column;">
    
    <!-- å¼¹çª—æ ‡é¢˜æ  -->
    <div class="modal-header" style="border-bottom: 2px solid #3498db; padding-bottom: 10px; margin-bottom: 15px; display:flex; justify-content:space-between; align-items:center;">
       <span style="font-size:18px; font-weight:bold; color:#2c3e50;">ğŸ“š æ™ºèƒ½ç†ç§‘è‰ç¨¿æœ¬ - å…¨èƒ½æŒ‡å—</span>
       <button style="border:none; background:none; cursor:pointer; font-size:24px; color:#999;" onclick="document.getElementById('help-modal').style.display='none'">Ã—</button>
    </div>

    <div class="modal-body" style="font-size: 14px; line-height: 1.6; overflow-y:auto; padding-right:5px;">
      
      <!-- æ¿å— 1: æ ¸å¿ƒäº¤äº’ -->
      <h3 style="color:#2c3e50; border-left: 4px solid #3498db; padding-left: 10px; margin-top: 0; background:#f4f6f8; padding-top:5px; padding-bottom:5px;">âš¡ æ ¸å¿ƒäº¤äº’æŠ€å·§</h3>
      <ul style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding-left: 20px; margin: 10px 0;">
        <li><strong>è®¡ç®—é¢„è§ˆï¼š</strong> è¾“å…¥ <code>1+1=</code> æ˜¾ç¤ºç°è‰²ç»“æœã€‚</li>
        <li><strong>ç¡®è®¤ä¸Šå±ï¼š</strong> æŒ‰ <span class="key-tag">Tab</span> é”®å°†ç»“æœå†™å…¥è‰ç¨¿ã€‚</li>
        <li><strong>æ™ºèƒ½ä¸Šæ ‡ï¼š</strong> è¾“å…¥ <code>x^-2</code> åæŒ‰ <span class="key-tag">ç©ºæ ¼</span> â†’ xâ»Â²ã€‚</li>
        <li><strong>ç¬¦å·æ›¿æ¢ï¼š</strong> <code>pi</code>â†’Ï€ï¼Œ<code>*</code>â†’Ã—ï¼Œ<code>sqrt</code>â†’âˆšã€‚</li>
        <li><strong>ç´ æç®¡ç†ï¼š</strong> <span class="key-tag">Ctrl+V</span> ç²˜è´´æˆªå›¾ï¼ŒåŒå‡»å›¾ç‰‡ç¼–è¾‘ã€‚</li>
        <li><strong>ä¸€é”®æ¸…å±ï¼š</strong> ç‚¹å‡»é¡¶éƒ¨â€œğŸ—‘ï¸ æ¸…å±â€é‡ç½®ç”»å¸ƒã€‚</li>
      </ul>

      <!-- æ¿å— 2: æ–‡ä»¶ç®¡ç† -->
      <h3 style="color:#2c3e50; border-left: 4px solid #e67e22; padding-left: 10px; background:#f4f6f8; padding-top:5px; padding-bottom:5px;">ğŸ“‚ æ–‡ä»¶ä¸é¡¹ç›®ç®¡ç†</h3>
      <div style="padding: 0 10px;">
        <p><strong>ğŸ’¾ å­˜ä¸ºæ–‡ä»¶å¤¹ï¼š</strong> æ¨èä½¿ç”¨ï¼ç³»ç»Ÿä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªå¸¦æ—¶é—´æˆ³çš„æ–‡ä»¶å¤¹ï¼ˆå¦‚ <code>20251010_ä½œä¸šA</code>ï¼‰ï¼Œå°†ä½ çš„<strong>æ–‡å­—è‰ç¨¿</strong>(txt)å’Œ<strong>æ‰€æœ‰å›¾ç‰‡ç´ æ</strong>(png)å®Œæ•´æ‰“åŒ…ä¿å­˜ã€‚</p>
        <p><strong>ğŸ“‚ æ‰“å¼€æ–‡ä»¶å¤¹ï¼š</strong> é€‰æ‹©ä¹‹å‰çš„é¡¹ç›®æ–‡ä»¶å¤¹ï¼Œå³å¯ä¸€é”®æ¢å¤å½“æ—¶çš„æ‰€æœ‰è®¡ç®—è¿‡ç¨‹å’Œå›¾ç‰‡æ ‡è®°ã€‚</p>
      </div>

      <!-- æ¿å— 3: ç†ç§‘å‡½æ•° -->
      <h3 style="color:#2c3e50; border-left: 4px solid #27ae60; padding-left: 10px; background:#f4f6f8; padding-top:5px; padding-bottom:5px;">ğŸ§® ç†ç§‘å‡½æ•°é€ŸæŸ¥è¡¨</h3>
      <table style="width:100%; font-size:13px; border-collapse: collapse; border: 1px solid #eee;">
        <tr style="background:#f8f9fa; color:#666; text-align:left;">
          <th style="padding:8px; border-bottom:1px solid #ddd;">åˆ†ç±»</th>
          <th style="padding:8px; border-bottom:1px solid #ddd;">è¯­æ³•ç¤ºä¾‹</th>
          <th style="padding:8px; border-bottom:1px solid #ddd;">è¯´æ˜</th>
        </tr>
        <tr>
          <td><strong>åŸºç¡€ä»£æ•°</strong></td>
          <td><code>5!</code> / <code>sqrt(9)</code> / <code>abs(-5)</code></td>
          <td>é˜¶ä¹˜ã€æ ¹å·ã€ç»å¯¹å€¼</td>
        </tr>
        <tr>
          <td><strong>ä¸‰è§’å‡½æ•°</strong></td>
          <td><code>sin(30 deg)</code> / <code>cos(pi)</code></td>
          <td>åŠ¡å¿…åŒºåˆ† deg(åº¦) å’Œ rad(å¼§åº¦)</td>
        </tr>
        <tr>
          <td><strong>æ’åˆ—ç»„åˆ</strong></td>
          <td><code>combinations(5, 2)</code></td>
          <td>ä» 5 ä¸ªä¸­å– 2 ä¸ªçš„ç»„åˆæ•° (Câ‚…Â²)</td>
        </tr>
        <tr>
          <td><strong>æ±‚å’Œ/ç»Ÿè®¡</strong></td>
          <td><code>sum(1, 2, 3)</code> / <code>mean(1, 2, 3)</code></td>
          <td>æ±‚å’Œã€æ±‚å¹³å‡å€¼</td>
        </tr>
        <tr>
          <td><strong>å¤æ‚æ±‚å’Œ</strong></td>
          <td><code>sigma(x^2, x, 1, 5)</code></td>
          <td>è®¡ç®— $\sum_{i=1}^{5} x^2$ (è¡¨è¾¾å¼, å˜é‡, èµ·å§‹, ç»“æŸ)</td>
        </tr>
        <tr>
          <td><strong>å¾®ç§¯åˆ†</strong></td>
          <td><code>d(x^2, x)</code> / <code>int(x^2, x, 0, 1)</code></td>
          <td>æ±‚å¯¼æ•° (Derivative) / å®šç§¯åˆ† (Integral)</td>
        </tr>
        <tr>
          <td><strong>çº¿æ€§ä»£æ•°</strong></td>
          <td><code>det([1, 2; 3, 4])</code></td>
          <td>è®¡ç®—è¡Œåˆ—å¼ (çŸ©é˜µç”¨ <code>;</code> åˆ†è¡Œ)</td>
        </tr>
        <tr>
          <td><strong>çŸ©é˜µè¿ç®—</strong></td>
          <td><code>[1, 2] * [3, 4]'</code></td>
          <td>çŸ©é˜µä¹˜æ³• (<code>'</code> è¡¨ç¤ºè½¬ç½®)</td>
        </tr>
      </table>

      <div style="text-align:center; margin-top:20px; padding-top:10px; border-top:1px solid #eee;">
        <button class="btn btn-primary" onclick="document.getElementById('help-modal').style.display='none'" style="padding: 8px 40px; font-size: 14px;">æˆ‘å­¦ä¼šäº†</button>
      </div>
    </div>
  </div>
</div>


<!-- === æ ¸å¿ƒé€»è¾‘åŒº === -->
<script>
  // 1. åˆå§‹åŒ– Math.js
  let mathLib = null;
  // --- æ–°å¢ï¼šä¸€é”®æ¸…å±åŠŸèƒ½ ---
  // --- ä¿®æ”¹åï¼šä¸€é”®æ¸…å± (æ–‡å­— + å›¾ç‰‡) ---
document.getElementById('btn-clear').onclick = () => {
    // æç¤ºè¯­å˜äº†ï¼Œå‘ŠçŸ¥ç”¨æˆ·å›¾ç‰‡ä¹Ÿä¼šæ²¡äº†
    if (confirm("ğŸ’¥ ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†…å®¹å—ï¼Ÿ\n\næ­¤æ“ä½œå°†åˆ é™¤ï¼š\n1. æ‰€æœ‰è‰ç¨¿æ–‡å­—\n2. ä¾§è¾¹æ æ‰€æœ‰å›¾ç‰‡ç´ æ\n\n(ä¸å¯æ’¤é”€ï¼Œè¯·è°¨æ…æ“ä½œ)")) {
        
        // 1. æ¸…ç©ºæ–‡å­—
        editor.value = "";
        
        // 2. æ¸…ç©ºå›¾ç‰‡ (ä¿ç•™æç¤ºè¯­ï¼Œåˆ é™¤æ‰€æœ‰ img-card)
        const sidebar = document.getElementById('image-sidebar');
        // é‡ç½®ä¸ºåˆå§‹çŠ¶æ€
        sidebar.innerHTML = '<div class="sidebar-tip">Ctrl+V ç²˜è´´å›¾ç‰‡<br>åŒå‡»åœ¨æ–°çª—å£ç¼–è¾‘</div>';
        
        // 3. è‡ªåŠ¨æ”¶èµ·ä¾§è¾¹æ  (å› ä¸ºå®ƒç©ºäº†)
        sidebar.classList.remove('active');

        // 4. ç«‹å³ä¿å­˜ç©ºçŠ¶æ€ & èšç„¦
        saveDraft();
        editor.focus();
        
        // ç»™ä¸ªè½»æç¤º
        if(window.utools) utools.showNotification("å·²æ¸…ç©ºæ‰€æœ‰å†…å®¹");
    }
};
  try {
      if(typeof math !== 'undefined') {
          const { create, all } = math;
          mathLib = create(all);
          // æ³¨å…¥è‡ªå®šä¹‰å‡½æ•°
          const integrate = (expr, v, s, e) => {
              const step=1000, h=(e-s)/step, f=mathLib.compile(expr), sc={};
              let sum=0; sc[v]=s; sum+=f.evaluate(sc); sc[v]=e; sum+=f.evaluate(sc);
              for(let i=1;i<step;i++) { sc[v]=s+i*h; sum+=(i%2===0?2:4)*f.evaluate(sc); }
              return (h/3)*sum;
          };
          const sigma = (expr, v, s, e) => {
              let sum=0, f=mathLib.compile(expr), sc={};
              for(let i=s;i<=e;i++) { sc[v]=i; sum+=f.evaluate(sc); }
              return sum;
          };
          mathLib.import({ d:mathLib.derivative, int:integrate, integral:integrate, sigma:sigma });
      } else {
          alert("é”™è¯¯ï¼šMath.js æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ math.min.js æ–‡ä»¶ï¼");
      }
  } catch(e) { console.error(e); }

  // ç¬¦å·æ˜ å°„
  const superscriptMap = { '0': 'â°', '1': 'Â¹', '2': 'Â²', '3': 'Â³', '4': 'â´', '5': 'âµ', '6': 'â¶', '7': 'â·', '8': 'â¸', '9': 'â¹', '+': 'âº', '-': 'â»', '(': 'â½', ')': 'â¾', 'n': 'â¿', '.': 'Ë™' };
  const reverseSuperscriptMap = Object.fromEntries(Object.entries(superscriptMap).map(([k, v]) => [v, k]));

  // MathLogic å·¥å…·å¯¹è±¡
  const MathLogic = {
      calculate: (input) => {
          if (!input || !input.trim() || !mathLib) return null;
          let clean = MathLogic.normalize(input);
          try {
              let res = mathLib.evaluate(clean);
              if (res !== undefined) {
                  let str = res.toString();
                  if (typeof res === 'number' && !Number.isInteger(res)) str = parseFloat(res.toFixed(4)).toString();
                  if (res.type === 'Unit') str = ' ' + str;
                  return str;
              }
          } catch (e) {}
          try {
              let fuzzy = clean.replace(/[^0-9+\-*/().%^a-zA-Z]/g, ''); 
              if (fuzzy && !/^[0-9.]+$/.test(fuzzy)) return mathLib.evaluate(fuzzy).toString();
          } catch (e) {}
          return null;
      },
      normalize: (s) => {
          s = s.replace(/Ã—/g, '*').replace(/Ã·/g, '/').replace(/Ï€/g, 'pi').replace(/âˆš/g, 'sqrt').replace(/â‰¤/g, '<=').replace(/â‰¥/g, '>=').replace(/â‰ /g, '!=');
          const supRegex = new RegExp(`[${Object.values(superscriptMap).join('')}]+`, 'g');
          s = s.replace(supRegex, (m) => '^' + m.split('').map(c => reverseSuperscriptMap[c]).join(''));
          return s.replace(/\^([+\-]\d+)/g, '^($1)').replace(/ï¼ˆ/g, '(').replace(/ï¼‰/g, ')').replace(/ï¼/g, '=').split('=')[0]; 
      },
      toSuperscript: (str) => {
          let c = ""; for (let char of str) c += superscriptMap[char] || char; return c;
      }
  };

  // 2. ä¸» UI é€»è¾‘
  const editor = document.getElementById('editor');
  const sidebar = document.getElementById('image-sidebar');
  const DB_ID = 'science_draft_v4'; 
  let isResultSelected = false;

  // è¾“å…¥äº‹ä»¶
  editor.addEventListener('input', (e) => {
      saveDraft();
      // è®¡ç®—
      if (e.data === '=' || e.data === 'ï¼') {
          const end = editor.selectionEnd;
          const text = editor.value.substring(0, end);
          const line = text.substring(text.lastIndexOf('\n') + 1, end - 1);
          const res = MathLogic.calculate(line);
          if (res) {
              editor.setRangeText(res.startsWith(' ')?res:(' '+res), end, end, 'select');
              isResultSelected = true;
          }
          return;
      }
      isResultSelected = false;
      // ç¬¦å·æ›¿æ¢
      if (e.inputType && e.inputType.startsWith("insert")) {
          const end = editor.selectionEnd;
          const val = editor.value;
          const before = val.substring(0, end);
          const after = val.substring(end);
          let n = val, off = 0;
          if (before.endsWith('*')) { n = before.slice(0,-1)+'Ã—'+after; }
          else if (before.endsWith('/')) { n = before.slice(0,-1)+'Ã·'+after; }
          else if (before.endsWith('pi')) { n = before.slice(0,-2)+'Ï€'+after; off=-1; }
          else if (before.endsWith('sqrt')) { n = before.slice(0,-4)+'âˆš'+after; off=-3; }
          if (n !== val) { editor.value = n; editor.selectionStart = end+off; editor.selectionEnd = end+off; saveDraft(); }
      }
  });

  // æŒ‰é”®äº‹ä»¶
  editor.addEventListener('keydown', (e) => {
      if (e.key === 'Tab') {
          if (isResultSelected) { e.preventDefault(); editor.selectionStart = editor.selectionEnd; isResultSelected = false; }
          else { e.preventDefault(); document.execCommand('insertText', false, '\t'); }
      }
      if (e.key === ' ') {
          const end = editor.selectionEnd;
          const match = editor.value.substring(0, end).match(/\^([0-9+\-n().]+)$/);
          if (match) {
              e.preventDefault();
              const conv = MathLogic.toSuperscript(match[1]);
              editor.setRangeText(conv + ' ', end - match[0].length, end, 'end');
              saveDraft();
          }
      }
  });

  // æ–‡ä»¶å¤¹ & ä¾§è¾¹æ åŠŸèƒ½
  document.getElementById('btn-save-folder').onclick = () => {
      if(!window.services) return alert("æ’ä»¶é”™è¯¯: preload.js æœªåŠ è½½");
      const path = window.services.selectFolder();
      if(!path) return;
      const imgs = []; document.querySelectorAll('#image-sidebar img').forEach(i => imgs.push(i.src));
      const res = window.services.saveToFolder(path, editor.value, imgs);
      if(res.success) utools.showNotification("å·²ä¿å­˜åˆ°: " + res.newPath);
      else alert("å¤±è´¥: " + res.error);
  };

  document.getElementById('btn-open-folder').onclick = () => {
      if(!window.services) return;
      const path = window.services.selectFolder();
      if(!path) return;
      const res = window.services.loadFromFolder(path);
      if(res.success) {
          editor.value = res.data.text;
          sidebar.innerHTML = '<div class="sidebar-tip">Ctrl+V ç²˜è´´å›¾ç‰‡<br>åŒå‡»åœ¨æ–°çª—å£ç¼–è¾‘</div>';
          res.data.images.forEach(addImageToSidebar);
          if(res.data.images.length) sidebar.classList.add('active');
          saveDraft();
          utools.showNotification("å¯¼å…¥æˆåŠŸ");
      } else alert("å¤±è´¥: " + res.error);
  };

  function addImageToSidebar(src) {
      const div = document.createElement('div'); div.className = 'img-card';
      const id = Date.now() + Math.random().toString(36).substr(2, 5);
      div.innerHTML = `<img src="${src}" data-id="${id}"><div class="del-btn">Ã—</div><div class="edit-hint">åŒå‡»ç¼–è¾‘</div>`;
      div.ondblclick = () => {
          if(!window.utools) return;
          localStorage.setItem('utools_paint_request', JSON.stringify({id, src}));
          utools.createBrowserWindow('editor.html', { title: 'ç»˜å›¾æ¿', width: 1000, height: 800, resizable: true, webPreferences: {nodeIntegration: true} });
      };
      div.querySelector('.del-btn').onclick = (e) => { e.stopPropagation(); div.remove(); saveDraft(); };
      sidebar.appendChild(div);
  }

  window.addEventListener('storage', (e) => {
      if (e.key === 'utools_paint_finished') {
          const p = JSON.parse(e.newValue);
          const img = document.querySelector(`img[data-id="${p.id}"]`);
          if(img) { 
              img.src = p.data; 
              saveDraft(); 
              img.parentElement.style.border="2px solid #2ecc71";
              setTimeout(()=>img.parentElement.style.border="2px solid transparent", 1000);
          }
          localStorage.removeItem('utools_paint_finished');
      }
  });

  document.addEventListener('paste', (e) => {
      const items = (e.clipboardData || e.originalEvent.clipboardData).items;
      for (let i in items) {
          if (items[i].kind === 'file' && items[i].type.includes('image/')) {
              const reader = new FileReader();
              reader.onload = (evt) => { addImageToSidebar(evt.target.result); saveDraft(); sidebar.classList.add('active'); };
              reader.readAsDataURL(items[i].getAsFile());
          }
      }
  });

  document.getElementById('btn-sidebar').onclick = () => sidebar.classList.toggle('active');
  document.getElementById('btn-help').onclick = () => document.getElementById('help-modal').style.display = 'flex';

  function saveDraft() {
     if(!window.utools) return;
     const imgs = []; document.querySelectorAll('#image-sidebar img').forEach(i => imgs.push(i.src));
     utools.db.put({ _id: DB_ID, data: { text: editor.value, images: imgs }, _rev: utools.db.get(DB_ID)?._rev });
  }
  function loadDraft() {
     editor.placeholder = "è¾“å…¥ 1+1= è®¡ç®—...\nè¾“å…¥ x^-2 [ç©ºæ ¼] å˜ä¸Šæ ‡...";
     if(!window.utools) return;
     const doc = utools.db.get(DB_ID);
     if(doc && doc.data) {
         editor.value = doc.data.text||'';
         (doc.data.images||[]).forEach(addImageToSidebar);
         if(doc.data.images?.length) sidebar.classList.add('active');
     } else { document.getElementById('help-modal').style.display = 'flex'; }
  }
  if(window.utools) utools.onPluginEnter(() => { editor.focus(); loadDraft(); }); else loadDraft();
</script>
</body>
</html>
